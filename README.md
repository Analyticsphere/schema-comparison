# Compare FlatConnect and Warren Schemas

This repository contains a Python script to compare the table schemas in the FlatConnect dataset (from BigQuery) against Warren's new schemas (provided as JSON files from [Box](https://nih.app.box.com/folder/302520767680)). The goal is to identify discrepancies between our existing FlatConnect schemas and the schemas generated by Warren’s pipeline that streams our data from Firestorm to BigQuery. The output can be used to communicate differences and improve the streaming pipeline.

## Overview

- **Old Schema Source:** BigQuery tables in the FlatConnect dataset.  
- **New Schema Source:** JSON schema files (one per table) stored in the `warren_schemas` directory. Files should follow the naming pattern: `<base_table>_<date>.json`.

The script compares the schemas based solely on column names and data types (ignoring column mode) and reports:
- Columns present in the FlatConnect schema but missing in the new schema.
- Columns present in the new schema but missing in the FlatConnect schema.
- Differences in data types for columns present in both.

## Prerequisites

- Python 3.7 or later.
- `google-cloud-bigquery` Python package. Install via pip:

```bash
pip install google-cloud-bigquery
```

- The local directory `warren_schemas` must contain the new schema JSON files.

## Usage

1. Update the configuration variables in `compare_streamed_and_flat_tables.py`:
   - **old_project**: Your BigQuery project ID.
   - **old_dataset**: The FlatConnect dataset name.
   - **new_schema_dir**: Path to the directory containing Warren’s schema JSON files.
   
2. Run the script:

```bash
python3 compare_streamed_and_flat_tables.py
```

## Output

The script prints the schema differences for each table to the console and writes all differences to a JSON file named `schema_comparison_results.json`.

### Output File Structure

The JSON output is structured as follows:
- **Key:** Base table name (with any `_JP` suffix removed).
- **Value:** An object containing:
  - `old_table`: Fully qualified BigQuery table name (e.g., `project.FlatConnect.table_JP`).
  - `new_schema`: The file pattern for the local JSON file (e.g., `warren_schemas/<base_table>*.json`).
  - `differences`: An object with:
    - `missing_in_new`: List of columns missing in the new schema.
    - `missing_in_old`: List of columns missing in the FlatConnect schema.
    - `field_differences`: Differences in data types for columns that exist in both schemas.

Use these results to track discrepancies and refine the streaming pipeline from Firestorm to BigQuery.
